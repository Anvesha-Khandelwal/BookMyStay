<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Complete Your Booking - BookMyStay</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --accent:#358793;
  --accent-soft:rgba(79,209,229,0.25);
  --card-light:rgba(255,255,255,0.78);
  --bg-page:#fdf8f2;
  --text-dark:#2b3a2d;
  --text-sub:#4a5568;
  --text-muted:#718096;
  --radius:32px;
}

body {
  margin:0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background:var(--bg-page);
  color:var(--text-dark);
}

nav {
  background: #fff;
  padding: 1rem 2rem;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.logo {
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--accent);
}

.nav-links {
float: relative;
  list-style: none;
  display: flex;
  gap: 2rem;
}

.nav-links a {
  text-decoration: none;
  color: var(--text-dark);
  font-weight: 600;
}

.booking-section {
  padding:2rem 1.2rem 3rem;
}

.booking-container {
  max-width:1020px;
  margin:auto;
  display:grid;
  grid-template-columns:1.3fr 1fr;
  gap:2rem;
}

@media(max-width:900px){
  .booking-container{
    grid-template-columns:1fr;
  }
}

.booking-form-wrapper h1 {
  font-size: 2rem;
  color: #567f63;
  margin-bottom: 2rem;
}

.booking-form-wrapper label {
  display: block;
  margin-top: 1rem;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: var(--text-dark);
}

.booking-summary-card {
  background:#fff;
  padding:1.6rem;
  border-radius:var(--radius);
  box-shadow:0 12px 42px rgba(0,0,0,0.06);
  border:1.8px solid #edf2f7;
  position:sticky;
  top:86px;
  backdrop-filter:blur(14px);
  transition:0.3s;
}

.booking-summary-card:hover{
  box-shadow:0 18px 56px rgba(0,0,0,0.1);
}

.booking-summary-title{
  font-size:1.45rem;
  font-weight:800;
  color:#567f63;
  margin-bottom:1rem;
}

.booking-summary-item {
  display:flex;
  justify-content:space-between;
  padding:0.8rem 0;
  border-bottom:1.5px dashed var(--accent-soft);
  font-size:0.92rem;
  font-weight:700;
  color:var(--text-dark);
}

.booking-summary-total{
  margin-top:1rem;
  padding:1rem 0.7rem;
  border-radius:16px;
  background:#f0f9ff;
  border:2px solid var(--accent-soft);
  display:flex;
  justify-content:space-between;
  font-weight:800;
  align-items:center;
}

#bTotal{
  color:#567f63;
  font-size:1.45rem;
}

.payment-card{
  background:#fff;
  padding:1.6rem;
  border-radius:var(--radius);
  box-shadow:0 12px 42px rgba(0,0,0,0.06);
  border:1.8px solid #edf2f7;
  margin-top:2rem;
  animation:fadeUp 0.6s ease-out;
}

.payment-title{
  color:#567f63;
  font-size:1.35rem;
  font-weight:800;
  margin:0 0 1rem;
}

input, select{
  width:100%;
  padding:1rem 1.2rem;
  border-radius:16px;
  border:2px solid rgba(0,0,0,0.06);
  font-size:0.92rem;
  font-weight:500;
  font-family:inherit;
  color:var(--text-dark);
  outline:none;
  transition:0.25s;
  margin-bottom:0.9rem;
  box-shadow:0 4px 16px rgba(0,0,0,0.015);
}

input:focus, select:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px var(--accent-soft);
}

.booking-btn-submit{
  width:100%;
  background:var(--accent);
  color:#fff;
  border:none;
  padding:1rem;
  border-radius:16px;
  font-weight:800;
  cursor:pointer;
  box-shadow:0 6px 18px var(--accent-soft);
  transition:0.3s;
  text-transform:uppercase;
  letter-spacing:0.6px;
  font-size:1rem;
}

.booking-btn-submit:hover{
  opacity:0.88;
  transform:translateY(-3px);
  box-shadow:0 12px 32px var(--accent-soft);
}

.booking-btn-submit:disabled{
  opacity:0.5;
  cursor:not-allowed;
  transform:none;
}

.offer-buttons {
  display:flex;
  gap:0.5rem;
  margin:1rem 0;
  flex-wrap:wrap;
}

.offer-btn {
  padding:0.6rem 1rem;
  background:#fff3cd;
  color:#856404;
  border:2px solid #ffc107;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
  transition:0.3s;
  font-size:0.85rem;
}

.offer-btn:hover {
  background:#ffc107;
  color:#fff;
  transform:translateY(-2px);
}

@keyframes fadeUp{
  from{opacity:0;transform:translateY(28px);}
  to{opacity:1;transform:none;}
}
</style>
</head>

<body>
<nav>
 <div class="logo"> BookMyStay</div>
 <ul class="nav-links"><li><a href="index.html">Home</a></li></ul>
</nav>

<section class="booking-section">
<div class="booking-container">

  <!-- FORM -->
  <div class="booking-form-wrapper">
    <h1>Finalize Booking</h1>
    <form id="bookingForm" onsubmit="submitBook(event)">
      <label><i class="fa fa-user"></i> Full Name</label>
      <input type="text" id="fName" placeholder="Enter your name" required />

      <label><i class="fa fa-envelope"></i> Email</label>
      <input type="email" id="fEmail" placeholder="your@email.com" required />

      <label><i class="fa fa-phone"></i> Phone</label>
      <input type="tel" id="fPhone" placeholder="+91 1234567890" required />

      <label><i class="fa fa-map-marker-alt"></i> Address</label>
      <input type="text" id="fAddr" placeholder="Your address" required />

      <label><i class="fa fa-calendar-check"></i> Check In</label>
      <input type="date" id="cin" required />

      <label><i class="fa fa-calendar-times"></i> Check Out</label>
      <input type="date" id="cout" required />

      <label><i class="fa fa-users"></i> Number of Rooms</label>
      <select id="gst" required>
        <option value="">Select rooms</option>
        <option value="1">1 Room</option>
        <option value="2">2 Rooms</option>
        <option value="3">3 Rooms</option>
        <option value="4">4 Rooms</option>
        <option value="5">5 Rooms</option>
      </select>

      <label>Special Request (Optional)</label>
      <input type="text" id="req" placeholder="Any special requirements..." />

      <div style="margin:1.5rem 0;">
        <h3 style="margin-bottom:0.8rem;">üéÅ Apply Special Offers</h3>
        <div class="offer-buttons">
          <button type="button" class="offer-btn" onclick="applyOffer('percent', 20)">20% OFF</button>
          <button type="button" class="offer-btn" onclick="applyOffer('flat', 500)">‚Çπ500 OFF</button>
          <button type="button" class="offer-btn" onclick="applyOffer('percent', 30)">30% OFF</button>
        </div>
      </div>
    </form>
  </div>

 
  <div>
    <div class="booking-summary-card">
      <div class="booking-summary-title">Booking Summary</div>

      <div class="booking-summary-item"><span>Hotel</span><span id="bName">-</span></div>
      <div class="booking-summary-item"><span>Check-In</span><span id="bIn">-</span></div>
      <div class="booking-summary-item"><span>Check-Out</span><span id="bOut">-</span></div>
      <div class="booking-summary-item"><span>Nights</span><span id="bN">1</span></div>
      <div class="booking-summary-item"><span>Rooms</span><span id="bG">-</span></div>
      <div class="booking-summary-item"><span>Price/Night</span><span id="bFare">‚Çπ0</span></div>
      <div class="booking-summary-item"><span>Subtotal</span><span id="bSubtotal">‚Çπ0</span></div>
      <div class="booking-summary-item" id="discountRow" style="display:none;color:#4caf50;">
        <span>Discount</span><span id="bDiscount">-‚Çπ0</span>
      </div>
      <div class="booking-summary-item"><span>Tax (12%)</span><span id="bTax">‚Çπ0</span></div>

      <div class="booking-summary-total"><span>Total Payable</span><span id="bTotal">‚Çπ0</span></div>
      
    </div>

    <!-- PAY NOW BUTTON -->
    <div class="payment-card">
      
      <div class="payment-title">Ready to Book?</div>
      <p style="color:var(--text-muted);font-size:0.9rem;margin-bottom:1.5rem;">
        Complete your booking details above and proceed to secure payment
      </p>
      <button type="button" class="booking-btn-submit" id="payNowBtn" onclick="proceedToPayment()">
        <i class="fas fa-lock"></i> Proceed to Payment
      </button>
    </div>
  </div>

</div>
</section>

<script>
// Check authentication
function checkAuth() {
  const isLoggedIn = localStorage.getItem('isLoggedIn');
  const token = localStorage.getItem('authToken');
  
  console.log('Checking auth - isLoggedIn:', isLoggedIn, 'token:', token);
  
  if (!isLoggedIn || !token) {
    alert('‚ö†Ô∏è Please login to continue with booking');
    localStorage.setItem('redirectAfterLogin', window.location.href);
    window.location.href = 'login.html';
    return false;
  }
  return true;
}

// Call auth check
if (!checkAuth()) {
  throw new Error('Not authenticated');
}

// Global variables
let discountAmount = 0;
let discountType = null;
let bookingData = {};

// Calculate booking summary
function calc() {
  try {
    const h = JSON.parse(localStorage.getItem("hotel") || "{}");
    const r = JSON.parse(localStorage.getItem("room") || "{}");
    const fare = r.p || h.price || 2500; // Default price if not set

    document.getElementById("bName").textContent = h.name || "Selected Hotel";
    
    const cinValue = document.getElementById("cin").value;
    const coutValue = document.getElementById("cout").value;
    
    document.getElementById("bIn").textContent = cinValue || "-";
    document.getElementById("bOut").textContent = coutValue || "-";
    document.getElementById("bFare").textContent = "‚Çπ" + fare;

    if (cinValue && coutValue) {
      const cinDate = new Date(cinValue);
      const coutDate = new Date(coutValue);
      const n = Math.max(1, Math.ceil((coutDate - cinDate) / (86400000)));
      const rooms = parseInt(document.getElementById("gst").value) || 1;
      
      document.getElementById("bN").textContent = n;
      document.getElementById("bG").textContent = rooms + " Room" + (rooms > 1 ? "s" : "");

      const subtotal = n * fare * rooms;
      document.getElementById("bSubtotal").textContent = "‚Çπ" + subtotal;

      // Apply discount
      let finalSubtotal = subtotal;
      let actualDiscount = 0;
      if (discountAmount > 0) {
        if (discountType === 'percent') {
          actualDiscount = Math.round((subtotal * discountAmount) / 100);
        } else {
          actualDiscount = discountAmount;
        }
        finalSubtotal = subtotal - actualDiscount;
        document.getElementById("discountRow").style.display = "flex";
        document.getElementById("bDiscount").textContent = "-‚Çπ" + actualDiscount;
      } else {
        document.getElementById("discountRow").style.display = "none";
      }

      const tax = Math.round(finalSubtotal * 0.12);
      const total = finalSubtotal + tax;
      
      document.getElementById("bTotal").textContent = "‚Çπ" + total;
      document.getElementById("bTax").textContent = "‚Çπ" + tax;

      // Store booking data
      bookingData = {
        hotelName: h.name || "Selected Hotel",
        checkIn: cinValue,
        checkOut: coutValue,
        nights: n,
        rooms: rooms,
        pricePerNight: fare,
        subtotal: subtotal,
        discount: actualDiscount,
        tax: tax,
        total: total,
        guestName: document.getElementById("fName").value,
        guestEmail: document.getElementById("fEmail").value,
        guestPhone: document.getElementById("fPhone").value,
        guestAddress: document.getElementById("fAddr").value,
        specialRequest: document.getElementById("req").value
      };
    }
  } catch (error) {
    console.error('Error in calc():', error);
  }
}

// Apply offer
function applyOffer(type, value) {
  discountType = type;
  discountAmount = value;
  calc();
  
  const msg = type === 'percent' ? `${value}% discount applied!` : `‚Çπ${value} discount applied!`;
  alert("‚úÖ " + msg);
}

// Form submit handler
function submitBook(e) {
  e.preventDefault();
  calc();
}

// Proceed to Payment
function proceedToPayment() {
  try {
    // Get form values
    const fName = document.getElementById("fName").value.trim();
    const fEmail = document.getElementById("fEmail").value.trim();
    const fPhone = document.getElementById("fPhone").value.trim();
    const fAddr = document.getElementById("fAddr").value.trim();
    const checkin = document.getElementById("cin").value;
    const checkout = document.getElementById("cout").value;
    const rooms = document.getElementById("gst").value;

    // Validate all fields
    if (!fName || !fEmail || !fPhone || !fAddr || !checkin || !checkout || !rooms) {
      alert("‚ö†Ô∏è Please fill all required fields before proceeding to payment");
      return;
    }

    // Validate email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(fEmail)) {
      alert("‚ö†Ô∏è Please enter a valid email address");
      return;
    }

    // Validate dates
    if (new Date(checkout) <= new Date(checkin)) {
      alert("‚ö†Ô∏è Check-out date must be after check-in date");
      return;
    }

    // Calculate final booking data
    calc();

    // Save to localStorage
    localStorage.setItem('pendingBooking', JSON.stringify(bookingData));
    console.log('Booking data saved:', bookingData);

    // Show loading state
    const btn = document.getElementById("payNowBtn");
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving booking details...';

    // Redirect after delay
    setTimeout(() => {
      alert('‚úÖ Booking details saved! Redirecting to payment page...');
      window.location.href = 'payment.html';
    }, 1000);

  } catch (error) {
    console.error('Error in proceedToPayment():', error);
    alert('‚ùå An error occurred. Please try again.');
    document.getElementById("payNowBtn").disabled = false;
    document.getElementById("payNowBtn").innerHTML = '<i class="fas fa-lock"></i> Proceed to Payment';
  }
}

// Event listeners
document.getElementById("cin").addEventListener('change', calc);
document.getElementById("cout").addEventListener('change', calc);
document.getElementById("gst").addEventListener('change', calc);

// Initialize on page load
window.addEventListener('DOMContentLoaded', function() {
  try {
    // Set minimum dates
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('cin').min = today;
    document.getElementById('cout').min = today;

    // Pre-fill user data
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (user.email) {
      document.getElementById('fEmail').value = user.email;
    }
    if (user.name) {
      document.getElementById('fName').value = user.name;
    }

    // Initial calculation
    calc();

    console.log('Booking page initialized successfully');
  } catch (error) {
    console.error('Error during initialization:', error);
  }
});
</script>

</body>
</html>